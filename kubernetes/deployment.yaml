---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: kube-vip-sample
---
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-vip
  namespace: kube-vip-sample
---
# ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-vip-sample-role
rules:
  - apiGroups: [""]
    resources: ["services", "endpoints", "nodes"]
    verbs: ["list", "get", "watch", "update"]
  - apiGroups: [""]
    resources: ["services/status"]
    verbs: ["update"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["list", "get", "watch", "update", "create"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["list", "get", "watch", "update", "create"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-vip-sample-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-vip-sample-role
subjects:
  - kind: ServiceAccount
    name: kube-vip
    namespace: kube-vip-sample
---
# ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-vip-config
  namespace: kube-vip-sample
data:
  # Range of IPs that kube-vip can assign to LoadBalancer services
  # Adjust this range to match your network
  # For Kind clusters: "172.18.0.200/29"
  # For other networks: adjust accordingly
  vip_cidr: "172.18.0.200/29"
---
# DaemonSet
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-vip
  namespace: kube-vip-sample
spec:
  selector:
    matchLabels:
      app: kube-vip
  template:
    metadata:
      labels:
        app: kube-vip
    spec:
      serviceAccountName: kube-vip
      hostNetwork: true
      containers:
      - name: kube-vip
        image: cleanstart/kube-vip:latest-dev
        imagePullPolicy: IfNotPresent
        command:
        - /usr/bin/kube-vip
        args:
        - manager
        - --interface=eth0
        - --services
        - --arp
        - --leaderElection
        - --leaseDuration=15
        - --leaseRenewDuration=10
        - --leaseRetry=2
        - --address=172.18.0.200
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
---
# Test Service (LoadBalancer)
apiVersion: v1
kind: Service
metadata:
  name: test-loadbalancer
  namespace: kube-vip-sample
  annotations:
    kube-vip.io/loadbalancerIPs: "172.18.0.200"
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  selector:
    app: test-app
---
# Test Application Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app
  namespace: kube-vip-sample
spec:
  replicas: 2
  selector:
    matchLabels:
      app: test-app
  template:
    metadata:
      labels:
        app: test-app
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 8080
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "<h1>Hello from Kube-VIP Test App</h1><p>Pod: $(hostname)</p>" > /usr/share/nginx/html/index.html
          sed -i 's/listen       80;/listen       8080;/' /etc/nginx/conf.d/default.conf
          nginx -g 'daemon off;'